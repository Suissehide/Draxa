{% extends 'layout.html.twig' %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/select2.min.css') }}">
{% endblock %}

{% block title %}Accueil{% endblock %}

{% block page_content %}
    <div class="wrapper">

        <div class="date-wrapper">
            <div id="paginator"></div>
        </div>

        {# Consultations #}
        <div class="accueil-wrapper">
            <div class="box">
                <div class="box-header">
                    <div>Consultations</div>
                    <span>prévues</span>
                </div>
                <table id="consultations" class="table table-condensed table-striped">
                    <thead>
                        <tr>
                            <th data-column-id="slot_horaire" data-width="10%">Horaire</th>
                            <th data-column-id="slot_thematique" data-width="20%">Thématique</th>
                            <th data-column-id="slot_type" data-width="10%">Type</th>
                            <th data-column-id="slot_soignant" data-width="15%">Soignant</th>
                            <th data-column-id="slot_location" data-width="15%">Lieu</th>
                            <th data-column-id="slot_patient" data-width="30%">Patient</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            {# Entretiens individuels #}
            <div class="box">
                <div class="box-header">
                    <div>Entretiens</div>
                    <span>prévus</span>
                </div>
                <table id="entretiens" class="table table-condensed table-striped">
                    <thead>
                        <tr>
                            <th data-column-id="slot_horaire" data-width="10%">Horaire</th>
                            <th data-column-id="slot_thematique" data-width="20%">Thématique</th>
                            <th data-column-id="slot_type" data-width="10%">Type</th>
                            <th data-column-id="slot_soignant" data-width="15%">Soignant</th>
                            <th data-column-id="slot_location" data-width="15%">Lieu</th>
                            <th data-column-id="slot_patient" data-width="30%">Patient</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            {# Ateliers #}
            <div class="box">
                <div class="box-header">
                    <div>Ateliers</div>
                    <span>prévus</span>
                </div>
                <table id="ateliers" class="table table-condensed table-striped">
                    <thead>
                        <tr>
                            <th data-column-id="slot_horaire" data-width="10%">Horaire</th>
                            <th data-column-id="slot_thematique" data-width="20%">Thématique</th>
                            <th data-column-id="slot_type" data-width="10%">Type</th>
                            <th data-column-id="slot_soignant" data-width="15%">Soignant</th>
                            <th data-column-id="slot_location" data-width="15%">Lieu</th>
                            <th data-column-id="slot_patient" data-width="30%">Patient</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="stats-wrapper">
            <div class="box-sm">
                <span class="glyphicon glyphicon-user"></span>
                <div class="stats">
                    <h1>Patients</h1>
                    <p>{{ nbPatients|number_format(0, ',', '.') }}</p>
                </div>
            </div>
            <div class="box-sm">
                <span class="glyphicon glyphicon-leaf"></span>
                <div class="stats">
                    <h1>Consultations</h1>
                    <p>{{ nbConsultation|number_format(0, ',', '.') }}</p>
                </div>
            </div>
            <div class="box-sm">
                <span class="glyphicon glyphicon-fire"></span>
                <div class="stats">
                    <h1>Entretiens</h1>
                    <p>{{ nbEntretiens|number_format(0, ',', '.') }}</p>
                </div>
            </div>
            <div class="box-sm">
                <span class="glyphicon glyphicon-tint"></span>
                <div class="stats">
                    <h1>Ateliers</h1>
                    <p>{{ nbAtelier|number_format(0, ',', '.') }}</p>
                </div>
            </div>
        </div>
    </div>

    <!--SVG Sprites-->
    <svg class="inline-svg">
        <symbol id="check" viewbox="0 0 12 10">
            <polyline points="1.5 6 4.5 9 10.5 1"></polyline>
        </symbol>
    </svg>

    <!-- Modal addPatient-->
    <div id="addPatient" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title modal__add">
                        <span class="glyphicon glyphicon-plus"></span>
                        Ajouter un patient
                    </h4>
                </div>
                <div class="modal-body">
                    {{ form_start(form) }}
                    {{ form_errors(form) }}

                    {{ form_row(form.rendezVous) }}
                    {{ form_row(form._token) }}
                    {{ form_end(form, {'render_rest' : false}) }}
                    <button id="patientAdd" class="btn btn-primary btn-block" data-dismiss="modal">Ajouter</button>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-default pull-left" data-dismiss="modal">
                        <span class="glyphicon glyphicon-remove"></span>
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
{% block javascripts %}
    <script src="{{ asset('js/select2.min.js') }}"></script>

    <script>
        var dateSelected = moment(new Date()).format('DD/MM/YYYY');
        var categorie = 'Consultation';

        var options = {
            selectedDateFormat: 'DD/MM/YYYY',
            selectedDate: dateSelected,
            onSelectedDateChanged: function (event, date) {
                dateSelected = moment(date).format('DD/MM/YYYY');
                ajaxAction(dateSelected);
            },
            language: 'fr',
            showCalendar: true
        }
        $('#paginator').datepaginator(options);

        {#  SELECT2  #}
        function matchCustom(params, data) {
            if ($.trim(params.term) === '') {
                return data;
            }

            if (typeof data.text === 'undefined') {
                return null;
            }

            if (data.text.indexOf(params.term) > -1) {
                return $.extend({}, data, true);;
            }
            return null;
        }

        $(".js-patient").select2({
            multiple: false,
            matcher: matchCustom,
        });

        {#    #}
        function ajaxAction(d) {
            $.ajax({
                    url: "{{ path('accueil_ajax') }}",
                    type: "POST",
                    dataType: "json",
                    data: {
                        "date": d
                    },
                    success: function (res) {
                        $("tbody tr").remove();
                        if (res[0].length > 0) {
                            $.each(res[0], function (index, val) {
                                $('<tr data-row-id=' + val.id + ' class="text-left">')
                                .append(`<td>` + val.horaire + `</td><td>` + val.thematique + `</td><td>` + val.type + `</td><td>` + val.soignant + `</td><td>` + val.location + `</td><td>` + createUser(val.patients, 'Consultation') + `</td>`)
                                .appendTo('#consultations');
                            });
                        } else {
                            $('<tr class="disabled text-center">').append('<td colspan="6">Aucune consultation</td>').appendTo('#consultations');
                        }
                        if (res[1].length > 0) {
                            $.each(res[1], function (index, val) {
                                $('<tr data-row-id=' + val.id + ' class="text-left">')
                                .append(`<td>` + val.horaire + `</td><td>` + val.thematique + `</td><td>` + val.type + `</td><td>` + val.soignant + `</td><td>` + val.location + `</td><td>` + createUser(val.patients, 'Entretien') + `</td>`)
                                .appendTo('#entretiens');
                            });
                        } else {
                            $('<tr class="disabled text-center">').append('<td colspan="6">Aucun entretien</td>').appendTo('#entretiens');
                        }
                        if (res[2].length > 0) {
                            $.each(res[2], function (index, val) {
                                $('<tr data-row-id=' + val.id + ' class="text-left">')
                                .append(`<td>` + val.horaire + `</td><td>` + val.thematique + `</td><td>` + val.type + `</td><td>` + val.soignant + `</td><td>` + val.location + `</td><td>` + createUser(val.patients, 'Atelier') + `</td>`)
                                .appendTo('#ateliers');
                            });
                        } else {
                            $('<tr class="disabled text-center">').append('<td colspan="6">Aucun atelier</td>').appendTo('#ateliers');
                        }

                        updateWidth();
                    }
                });
        }
        ajaxAction(dateSelected);

        /*
        ============================================================================== */

        var $table = $('table'),
            $headCells = $('table:first thead tr').children(),
            headWidth;

        // Get the tbody columns width array
        headWidth = $headCells.map(function() {
            return $(this).data('width');
        }).get();

        // Set the width of thead columns
        function updateWidth() {
            $table.find('tbody tr').each(function(i, v) {
                $(v).children().each(function(j, s) {
                    $(s).width(headWidth[j]);
                });
            });
        }
        updateWidth();

        function createUser(data, c) {
            let label = ''
            label += '<div class="user-list">';
            if (data.length !== 0) {
                data.forEach(function(e, v) {
                    let checked = (e.send === 'Oui' ? 'checked' : '');
                    label += `
                        <div class="user-label" data-id="` + e.rendezVousId + `">
                            <div>
                                <div class="user-send">
                                    <input class="inp-cbx" id="` + e.rendezVousId + `" type="checkbox" ` + checked + `/>
                                    <label class="cbx" for="` + e.rendezVousId + `">
                                        <span>
                                            <svg width="12px" height="10px"><use xlink:href="#check"></use></svg>
                                        </span>     
                                    </label>
                                </div>
                                <div class="user-name">` + e.prenom + ` ` + e.nom + `</div>
                            </div>
                            <div>
                                <button class="js-removePatient"><i class="glyphicon glyphicon-minus"></i></button>
                                <button class="js-redirect" data-id="` + e.patientId + `"><i class="glyphicon glyphicon-pencil"></i></button>
                            </div>
                        </div>
                    `;
                });
            }
            if ((c == 'Atelier') || data.length === 0)
                label += '<button class="js-addPatient"><i class="glyphicon glyphicon-plus"></i></button>';
            label += '</div>';
            return label;
        }

        $('tbody ').on('click', '.inp-cbx', function(e) {
            e.stopPropagation();

            let id = $(this).attr('id');
            let send = $(this).is(":checked") ? 'Oui': 'Non';
            $.ajax({
                url: "{{ path('rendezVous_send') }}",
                type: "POST",
                dataType: "json",
                data: {
                    id: id,
                    send: send
                },
                success: function (res) {
                    // console.log(res);
                }
            });
        })

        /* 
        ============================================================================== */

        $('tbody').on('click', '.js-redirect', function() {
            let patientId = $(this).attr('data-id');
            let anchor_list = ["consultations", "entretiens", "ateliers"];
            let anchor = anchor_list[$(this).parents('.box').index()];
            $.ajax({
                url: "{{ path('redirect_vue_patient') }}",
                type: "POST",
                dataType: "json",
                data: {
                    id: patientId,
                    anchor: anchor
                },
                success: function (res) {
                    window.location.href = res;
                }
            });
        });


        $('tbody').on('click', '.js-addPatient', function() {
            let id = $(this).closest('tr').attr('data-row-id');
            $('#patientAdd').attr('data-id', id);
            $('#addPatient').modal('show');
        });

        $('#patientAdd').on('click', function() {
            let slotId = $(this).data('id');
            let tr = $('tbody tr[data-row-id="' + slotId + '"]');
            let patientId = $('#add_patient_rendezVous').val();

            let heure = tr.find('td:first-child').text().split(' - ')[0];

            $.ajax({
                url: "{{ path('add_patient_slot') }}",
                type: "POST",
                dataType: "json",
                data: {
                    date: dateSelected,
                    heure: heure,
                    categorie: categorie,
                    patientId: patientId,
                    slotId: slotId
                },
                success: function (res) {
                    let checked = (res.send === 'Oui' ? 'checked' : '');
                    let label = `
                        <div class="user-label" data-id="` + res.rendezVousId + `">
                            <div>
                                <div class="user-send">
                                    <input class="inp-cbx" id="` + res.rendezVousId + `" type="checkbox" ` + checked + `/>
                                    <label class="cbx" for="` + res.rendezVousId + `">
                                        <span>
                                            <svg width="12px" height="10px"><use xlink:href="#check"></use></svg>
                                        </span>     
                                    </label>
                                </div>
                                <div class="user-name">` + res.prenom + ` ` + res.nom + `</div>
                            </div>
                            <div>
                                <button class="js-removePatient"><i class="glyphicon glyphicon-minus"></i></button>
                                <button class="js-redirect" data-id="` + patientId + `"><i class="glyphicon glyphicon-pencil"></i></button>
                            </div>
                        </div>
                    `;
                    tr.find('.user-list').prepend(label);
                    if (categorie != 'Atelier')
                        tr.find('.js-addPatient').remove();
                }
            });
        })

        $('tbody').on('click', '.js-removePatient', function() {
            let label = $(this).closest('.user-label');
            let rendezVousId = label.data('id');
            $.ajax({
                url: "{{ path('remove_patient_slot') }}",
                type: "POST",
                dataType: "json",
                data: {
                    rendezVousId: rendezVousId,
                },
                success: function (res) {
                    if (categorie != 'Atelier') {
                        label.after('<button class="js-addPatient"><i class="glyphicon glyphicon-plus"></i></button>');
                    }
                    label.remove();
                }
            });
        });

        $('tbody').on('click', function() {
            categorie = 'Consultation';
            if ($(this).closest('table').is("#entretiens"))
                categorie = 'Entretien';
            else if ($(this).closest('table').is("#ateliers"))
                categorie = 'Atelier';
        });

    </script>
{% endblock %}