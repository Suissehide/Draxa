{% extends 'layout.html.twig' %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/timeline.css') }}">
{% endblock %}

{% block title %}
    Vue
    {{ patient.nom }}
{% endblock %}

{% block page_content %}

    <div class="wrapper">
        <h1 id="top">Index |
            {{ patient.nom }}</h1>
        <div class="well nav-bar" id="navMenu">
            <div class="btn-group btn-nav">
                <a href="{{ url('patient') }}" class="btn btn-default">
                    <span class="glyphicon glyphicon-chevron-left"></span>
                    Retour
                </a>
                <a href="#details" class="js-scrollTo btn btn-primary" data-row-id="0">
                    <span class="glyphicon glyphicon-search"></span>
                    Informations
                </a>
                <a href="#infos" class="js-scrollTo btn btn-primary" data-row-id="0">
                    <span class="glyphicon glyphicon-paperclip"></span>
                    Atelier Infos
                </a>
                <a href="#bcvs" class="js-scrollTo btn btn-primary" data-row-id="0">
                    <span class="glyphicon glyphicon-briefcase"></span>
                    BCVs
                </a>
                <a href="#consultations" class="js-scrollTo btn btn-primary" data-row-id="0">
                    <span class="glyphicon glyphicon-book"></span>
                    Consultations
                </a>
                <a href="#entretiens" class="js-scrollTo btn btn-primary" data-row-id="0">
                    <span class="glyphicon glyphicon-bookmark"></span>
                    Entretiens individuels
                </a>
                <a href="#ateliers" class="js-scrollTo btn btn-primary" data-row-id="0">
                    <span class="glyphicon glyphicon-scissors"></span>
                    Atelier
                </a>
                <a href="#suivi" class="js-scrollTo btn btn-primary" data-row-id="0">
                    <span class="glyphicon glyphicon-phone"></span>
                    Suivi téléphonique
                </a>
                <a href="#activite" class="js-scrollTo btn btn-primary" data-row-id="0">
                    <span class="glyphicon glyphicon-comment"></span>
                    Activité
                </a>
            </div>
        </div>

        <div class="content">

            {{ form_start(form) }}
            {{ form_errors(form) }}

            <div class="row">
                <div class="col-md-12">
                    {{ form_row(form.observ, {'required': false}) }}
                </div>
            </div>
            <div class="separator">
                <span id="details" class="separator-text">Détails</span>
            </div>
            <div class="row">
                <div class="col-md-2">
                    {{ form_row(form.sexe) }}
                </div>
                <div class="col-md-3">
                    {{ form_row(form.nom) }}
                </div>
                <div class="col-md-3">
                    {{ form_row(form.prenom) }}
                </div>
                <div class="col-md-2">
                    {{ form_row(form.date) }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-2">
                    {{ form_row(form.tel1) }}
                </div>
                <div class="col-md-2">
                    {{ form_row(form.tel2, {'required': false}) }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    {{ form_row(form.distance) }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-2">
                    {{ form_row(form.etude) }}
                </div>
                <div class="col-md-4">
                    {{ form_row(form.profession) }}
                </div>
                <div class="col-md-2">
                    {{ form_row(form.activite) }}
                </div>
            </div>
            <div class="separator">
                <span class="separator-text">Données à l'inclusion</span>
            </div>
            <div class="row">
                <div class="col-md-2">
                    {{ form_row(form.diagnostic) }}
                </div>
                <div class="col-md-3">
                    {{ form_row(form.dedate) }}
                </div>
                <div class="col-md-4">
                    {{ form_row(form.orientation, {'required': false}) }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-2">
                    {{ form_row(form.etpdecision) }}
                </div>
                <div class="col-md-3">
                    {{ form_row(form.progetp) }}
                </div>
                <div class="col-md-4">
                    {{ form_row(form.precisions, {'required': false}) }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    {{ form_row(form.precisionsperso, {'required': false}) }}
                </div>
            </div>

            <div class="separator">
                <span id="fin" class="separator-text">Données à la sortie</span>
            </div>
            <div class="row">
		        <div class="col-md-3">
                    {{ form_row(form.dentree) }}
                </div>
	        </div>
            <div class="row">
                <div class="col-md-4">
                    {{ form_row(form.motif, {'required': false}) }}
                </div>
                <div class="col-md-4">
                    {{ form_row(form.etp, {'required': false}) }}
                </div>
            </div>

            <div class="separator">
                <span id="infos" class="separator-text">Atelier Infos</span>
            </div>

            <section class="cd-horizontal-timeline row" id="timeline-infos">
                <div class="timeline">
                    <div class="events-wrapper">
                        <div class="events">
                            <ol id="events-infos">
                                {% for infosForm in form.infos %}
                                    <li>
                                        <a href="#0" data-date="{{ infosForm.vars.value.date|date("d/m/Y") }}" {% if loop.last %} class="selected" {% else %} class="older-event" {% endif %}>
                                            {{ infosForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM')  }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ol>

                            <span class="filling-line" aria-hidden="true"></span>
                        </div>
                        <!-- .events -->
                    </div>
                    <!-- .events-wrapper -->

                    <ul class="cd-timeline-navigation">
                        <li>
                            <a href="#0" class="prev inactive">Prev</a>
                        </li>
                        <li>
                            <a href="#0" class="next">Next</a>
                        </li>
                    </ul>

                    <a class="new" data-toggle="modal" data-target="#infosModal">
                        <span class="glyphicon glyphicon-plus"></span></a>
                    <!-- .cd-timeline-navigation -->
                </div>
                <!-- .timeline -->

                <div class="events-content">
                    <ol id="events-content-infos">
                        {% for infosForm in form.infos %}
                            {% set counter = (counter | default(0)) + 1 %}
                            <li {% if loop.last %} class="selected" {% endif %} data-date="{{ infosForm.vars.value.date|date("d/m/Y") }}">
                                <h2>Atelier Infos 
                                    {{ counter }}
                                </h2>
                                <em>
                                    {{ infosForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM y') }}
                                </em>
                                <div class="row">
                                    {{ form_row(infosForm.date) }}
                                </div>
                                <div class="row">
                                    {{ form_row(infosForm.type) }}
                                </div>
                                <div class="row">
                                    {{ form_row(infosForm.accompagnant) }}
                                </div>
                                <div class="row">
                                    {{ form_row(infosForm.etat) }}
                                </div>
                                <div class="row">
                                    {{ form_row(infosForm.motifRefus, {'required': false}) }}
                                </div>
                                <div class="row">
                                    <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                    <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                </div>
                            </li>
                        {% endfor %}
                    </ol>

                </div>
                <!-- .events-content -->
            </section>

            <div class="separator">
                <span id="bcvs" class="separator-text">BCVs</span>
            </div>

            <section class="cd-horizontal-timeline row" id="timeline-BCVs">
                <div class="timeline">
                    <div class="events-wrapper">
                        <div class="events">
                            <ol id="events-BCVs">
                                {% for BCVsForm in form.bcvs %}
                                    <li>
                                        <a href="#0" data-date="{{ BCVsForm.vars.value.date|date("d/m/Y") }}" {% if loop.last %} class="selected" {% else %} class="older-event" {% endif %}>
                                            {{ BCVsForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM')  }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ol>

                            <span class="filling-line" aria-hidden="true"></span>
                        </div>
                        <!-- .events -->
                    </div>
                    <!-- .events-wrapper -->

                    <ul class="cd-timeline-navigation">
                        <li>
                            <a href="#0" class="prev inactive">Prev</a>
                        </li>
                        <li>
                            <a href="#0" class="next">Next</a>
                        </li>
                    </ul>

                    <a class="new" data-toggle="modal" data-target="#bcvsModal">
                        <span class="glyphicon glyphicon-plus"></span></a>
                    <!-- .cd-timeline-navigation -->
                </div>
                <!-- .timeline -->

                <div class="events-content">
                    <ol id="events-content-bcvs">
                        {% for bcvsForm in form.bcvs %}
                            {% set counter = (counter | default(0)) + 1 %}
                            <li {% if loop.last %} class="selected" {% endif %} data-date="{{ bcvsForm.vars.value.date|date("d/m/Y") }}">
                                <h2>BCVs 
                                    {{ counter }}
                                </h2>
                                <em>
                                    {{ bcvsForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM y') }}
                                </em>
                                <div class="row">
                                    {{ form_row(bcvsForm.date) }}
                                </div>
                                <div class="row">
                                    {{ form_row(bcvsForm.accompagnant) }}
                                </div>
                                <div class="row">
                                    {{ form_row(bcvsForm.permission) }}
                                </div>
                                <div class="row">
                                    {{ form_row(bcvsForm.etat) }}
                                </div>
                                <div class="row">
                                    {{ form_row(bcvsForm.motifRefus, {'required': false}) }}
                                </div>
                                <div class="row">
                                    <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                    <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                </div>
                            </li>
                        {% endfor %}
                    </ol>

                </div>
                <!-- .events-content -->
            </section>

            <div class="separator">
                <span id="consultations" class="separator-text">Consultations</span>
            </div>

            <section class="cd-horizontal-timeline row" id="timeline-rendezVous">
                <div class="timeline">
                    <div class="events-wrapper">
                        <div class="events">
                            <ol id="events-rendezVous">
                                {% for rendezVousForm in form.rendezVous %}
                                    <li>
                                        <a href="#0" data-date="{{ rendezVousForm.vars.value.date|date("d/m/Y") }}" {% if loop.last %} class="selected" {% else %} class="older-event" {% endif %}>
                                            {{ rendezVousForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM')  }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ol>

                            <span class="filling-line" aria-hidden="true"></span>
                        </div>
                        <!-- .events -->
                    </div>
                    <!-- .events-wrapper -->

                    <ul class="cd-timeline-navigation">
                        <li>
                            <a href="#0" class="prev inactive">Prev</a>
                        </li>
                        <li>
                            <a href="#0" class="next">Next</a>
                        </li>
                    </ul>

                    <a class="new" data-toggle="modal" data-target="#rendezVousModal">
                        <span class="glyphicon glyphicon-plus"></span></a>
                    <!-- .cd-timeline-navigation -->
                </div>
                <!-- .timeline -->

                <div class="events-content">
                    <ol id="events-content-rendezVous">
                        {% for rendezVousForm in form.rendezVous %}
                            {% set counter = (counter | default(0)) + 1 %}
                            <li {% if loop.last %} class="selected" {% endif %} data-date="{{ rendezVousForm.vars.value.date|date("d/m/Y") }}">
                                <h2>Consultation  
                                    {{ counter }}
                                </h2>
                                <em>
                                    {{ rendezVousForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM y') }}
                                </em>
                                <div class="row">
                                    {{ form_row(rendezVousForm.date) }}
                                </div>
                                <div class="row">
                                    {{ form_row(rendezVousForm.thematique) }}
                                </div>
                                <div class="row">
                                    {{ form_row(rendezVousForm.heure) }}
                                </div>
                                <div class="row">
                                    {{ form_row(rendezVousForm.type) }}
                                </div>
                                <div class="row">
                                    {{ form_row(rendezVousForm.accompagnant) }}
                                </div>
                                <div class="row">
                                    {{ form_row(rendezVousForm.etat) }}
                                </div>
                                <div class="row">
                                    {{ form_row(rendezVousForm.motifRefus, {'required': false}) }}
                                </div>
                                <div class="row">
                                    <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                    <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                </div>
                            </li>
                        {% endfor %}
                    </ol>

                </div>
                <!-- .events-content -->
            </section>

            <div class="separator">
                <span id="entretiens" class="separator-text">Entretiens individuels</span>
            </div>

            <section class="cd-horizontal-timeline row" id="timeline-entretiens">
                <div class="timeline">
                    <div class="events-wrapper">
                        <div class="events">
                            <ol id="events-entretiens">
                                {% for entretienForm in form.entretiens %}
                                    <li>
                                        <a href="#0" data-date="{{ entretienForm.vars.value.date|date("d/m/Y") }}" {% if loop.last %} class="selected" {% else %} class="older-event" {% endif %}>
                                            {{ entretienForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM')  }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ol>

                            <span class="filling-line" aria-hidden="true"></span>
                        </div>
                        <!-- .events -->
                    </div>
                    <!-- .events-wrapper -->

                    <ul class="cd-timeline-navigation">
                        <li>
                            <a href="#0" class="prev inactive">Prev</a>
                        </li>
                        <li>
                            <a href="#0" class="next">Next</a>
                        </li>
                    </ul>

                    <a class="new" data-toggle="modal" data-target="#entretienModal">
                        <span class="glyphicon glyphicon-plus"></span></a>
                    <!-- .cd-timeline-navigation -->
                </div>
                <!-- .timeline -->

                <div class="events-content">
                    <ol id="events-content-entretiens">
                        {% for entretienForm in form.entretiens %}
                            {% set counter = (counter | default(0)) + 1 %}
                            <li {% if loop.last %} class="selected" {% endif %} data-date="{{ entretienForm.vars.value.date|date("d/m/Y") }}">
                                <h2>Entretien individuel
                                    {{ counter }}
                                </h2>
                                <em>
                                    {{ entretienForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM y')  }}
                                </em>
                                <div class="row">
                                    {{ form_row(entretienForm.date) }}
                                </div>
                                <div class="row">
                                    {{ form_row(entretienForm.thematique) }}
                                </div>
                                <div class="row">
                                    {{ form_row(entretienForm.heure) }}
                                </div>
                                <div class="row">
                                    {{ form_row(entretienForm.type) }}
                                </div>
                                <div class="row">
                                    {{ form_row(entretienForm.accompagnant, {'required': false}) }}
                                </div>
                                <div class="row">
                                    {{ form_row(entretienForm.etat) }}
                                </div>
                                <div class="row">
                                    {{ form_row(entretienForm.motifRefus, {'required': false}) }}
                                </div>
                                <div class="row">
                                    <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                    <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                </div>
                            </li>
                        {% endfor %}
                    </ol>
                </div>
                <!-- .events-content -->
            </section>

            <div class="separator">
                <span id="ateliers" class="separator-text">Atelier</span>
            </div>

            <section class="cd-horizontal-timeline row" id="timeline-ateliers">
                <div class="timeline">
                    <div class="events-wrapper">
                        <div class="events">
                            <ol id="events-ateliers">
                                {% for atelierForm in form.ateliers %}
                                    <li>
                                        <a href="#0" data-date="{{ atelierForm.vars.value.date|date("d/m/Y") }}" {% if loop.last %} class="selected" {% else %} class="older-event" {% endif %}>
                                            {{ atelierForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM')  }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ol>

                            <span class="filling-line" aria-hidden="true"></span>
                        </div>
                        <!-- .events -->
                    </div>
                    <!-- .events-wrapper -->

                    <ul class="cd-timeline-navigation">
                        <li>
                            <a href="#0" class="prev inactive">Prev</a>
                        </li>
                        <li>
                            <a href="#0" class="next">Next</a>
                        </li>
                    </ul>

                    <a class="new" data-toggle="modal" data-target="#atelierModal">
                        <span class="glyphicon glyphicon-plus"></span></a>
                    <!-- .cd-timeline-navigation -->
                </div>
                <!-- .timeline -->

                <div class="events-content">
                    <ol id="events-content-ateliers">
                        {% for atelierForm in form.ateliers %}
                            {% set counter = (counter | default(0)) + 1 %}
                            <li {% if loop.last %} class="selected" {% endif %} data-date="{{ atelierForm.vars.value.date|date("d/m/Y") }}">
                                <h2>Atelier
                                    {{ counter }}
                                </h2>
                                <em>
                                    {{ atelierForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM y')  }}
                                </em>
                                <div class="row">
                                    {{ form_row(atelierForm.date) }}
                                </div>
                                <div class="row">
                                    {{ form_row(atelierForm.thematique) }}
                                </div>
                                <div class="row">
                                    {{ form_row(atelierForm.heure) }}
                                </div>
                                <div class="row">
                                    {{ form_row(atelierForm.type) }}
                                </div>
                                <div class="row">
                                    {{ form_row(atelierForm.accompagnant, {'required': false}) }}
                                </div>
                                <div class="row">
                                    {{ form_row(atelierForm.etat) }}
                                </div>
                                <div class="row">
                                    {{ form_row(atelierForm.motifRefus, {'required': false}) }}
                                </div>
                                <div class="row">
                                    <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                    <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                </div>
                            </li>
                        {% endfor %}
                    </ol>
                </div>
                <!-- .events-content -->
            </section>

            <div class="separator">
                <span id="suivi" class="separator-text">Suivi téléphonique</span>
            </div>

            <section class="cd-horizontal-timeline row" id="timeline-telephoniques">
                <div class="timeline">
                    <div class="events-wrapper">
                        <div class="events">
                            <ol id="events-telephoniques">
                                {% for telephoniqueForm in form.telephoniques %}
                                    <li>
                                        <a href="#0" data-date="{{ telephoniqueForm.vars.value.date|date("d/m/Y") }}" {% if loop.last %} class="selected" {% else %} class="older-event" {% endif %}>
                                            {{ telephoniqueForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM')  }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ol>

                            <span class="filling-line" aria-hidden="true"></span>
                        </div>
                        <!-- .events -->
                    </div>
                    <!-- .events-wrapper -->

                    <ul class="cd-timeline-navigation">
                        <li>
                            <a href="#0" class="prev inactive">Prev</a>
                        </li>
                        <li>
                            <a href="#0" class="next">Next</a>
                        </li>
                    </ul>

                    <a class="new" data-toggle="modal" data-target="#telephoniqueModal">
                        <span class="glyphicon glyphicon-plus"></span></a>
                    <!-- .cd-timeline-navigation -->
                </div>
                <!-- .timeline -->

                <div class="events-content">
                    <ol id="events-content-telephoniques">
                        {% for telephoniqueForm in form.telephoniques %}
                            {% set counter = (counter | default(0)) + 1 %}
                            <li {% if loop.last %} class="selected" {% endif %} data-date="{{ telephoniqueForm.vars.value.date|date("d/m/Y") }}">
                                <h2>Rendez-vous téléphonique
                                    {{ counter }}
                                </h2>
                                <em>
                                    {{ telephoniqueForm.vars.value.date|localizeddate('none', 'none', 'fr', null, 'd MMMM y')  }}
                                </em>
                                <div class="row">
                                    {{ form_row(telephoniqueForm.date) }}
                                </div>
                                <div class="row">
                                    {{ form_row(telephoniqueForm.thematique) }}
                                </div>
                                <div class="row">
                                    {{ form_row(telephoniqueForm.etat) }}
                                </div>
                                <div class="row">
                                    {{ form_row(telephoniqueForm.motifRefus, {'required': false}) }}
                                </div>
                                <div class="row">
                                    <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                    <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                </div>
                            </li>
                        {% endfor %}
                    </ol>
                </div>
                <!-- .events-content -->
            </section>

            <div class="separator">
                <span id="activite" class="separator-text">Activité</span>
            </div>

            <div class="activity-wrapper">
                <div class="card card-add">
                    <span class="glyphicon glyphicon-plus"></span>
                </div>
                <div class="scrollbar list-wrapper">
                    <ul class="list-content annexes" data-prototype="{{ form_widget(form.annexes.vars.prototype)|e('html_attr') }}">
                        {% for annexesForm in form.annexes | reverse %}
                            <li class="card">
                                {{ form_row(annexesForm.date) }}
                                {{ form_row(annexesForm.action) }}
                                <button type="button" class="btn btn-danger pull-left remove-tag annexe-old">Supprimer</button>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="separator"></div>
            <div class="row form-inline">
                <a href="{{ url('patient') }}" class="btn btn-default">
                    <span class="glyphicon glyphicon-chevron-left"></span>
                    Retour
                </a>
                <a href="#0" class="btn btn-danger" data-toggle="modal" data-target="#supprModal">
                    <span class="glyphicon glyphicon-trash"></span>
                    Supprimer
                </a>
                {{ form_row(form.validation, {'attr': {'class': 'btn btn-primary'} }) }}
            </div>

            {{ form_row(form._token) }}
            {{ form_end(form, {'render_rest' : false}) }}
        </div>
        <!-- End content -->

        <!-- Modal supprPatient-->
        <div id="supprModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-warning"></span>
                            Suppression</h4>
                    </div>
                    <div class="modal-body">
                        <p>Êtes-vous sûr de vouloir supprimer ce patient ?</p>
                        <form method="post" action="{{ path('patient_delete', {'id': patient.id}) }}">
                            <input type="hidden" name="_method" value="DELETE">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ patient.id) }}">
                            <button class="btn btn-primary btn-block-md">Oui</button>
                            <button class="btn btn-danger btn-block-md" data-dismiss="modal">Non</button>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-default pull-left" data-dismiss="modal">
                            <span class="glyphicon glyphicon-remove"></span>
                            Annuler</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal addRendezVous-->
        <div id="rendezVousModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-plus"></span>
                            Ajouter une consultation</h4>
                    </div>
                    <div class="modal-body">
                        {{ form_start(formRendezVous) }}
                        {{ form_errors(formRendezVous) }}
                        {{ form_row(formRendezVous.date, {'attr': {'autocomplete': 'off'} }) }}
                        {{ form_row(formRendezVous.thematique) }}
                        {{ form_row(formRendezVous.heure) }}
                        {{ form_row(formRendezVous.type) }}
                        {{ form_row(formRendezVous.accompagnant, {'required': false}) }}
                        {{ form_row(formRendezVous.etat, {'required': false}) }}
                        {{ form_row(formRendezVous.motifRefus, {'required': false}) }}
                        {{ form_row(formRendezVous._token) }}
                        {{ form_end(formRendezVous, {'render_rest' : false}) }}
                        <button id="rendezVous_add" class="btn btn-primary btn-block" data-dismiss="modal" disabled="disabled">Ajouter</button>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-default pull-left" data-dismiss="modal">
                            <span class="glyphicon glyphicon-remove"></span>
                            Annuler</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal addEntretien-->
        <div id="entretienModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-plus"></span>
                            Ajouter un entretien</h4>
                    </div>
                    <div class="modal-body">
                        {{ form_start(formEntretien) }}
                        {{ form_errors(formEntretien) }}
                        {{ form_row(formEntretien.date, {'attr': {'autocomplete': 'off'} }) }}
                        {{ form_row(formEntretien.thematique) }}
                        {{ form_row(formEntretien.heure) }}
                        {{ form_row(formEntretien.type) }}
                        {{ form_row(formEntretien.accompagnant, {'required': false}) }}
                        {{ form_row(formEntretien.etat) }}
                        {{ form_row(formEntretien.motifRefus, {'required': false}) }}
                        {{ form_row(formEntretien._token) }}
                        {{ form_end(formEntretien, {'render_rest' : false}) }}
                        <button id="entretien_add" class="btn btn-primary btn-block" data-dismiss="modal" disabled="disabled">Ajouter</button>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-default pull-left" data-dismiss="modal">
                            <span class="glyphicon glyphicon-remove"></span>
                            Annuler</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal addAtelier-->
        <div id="atelierModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-plus"></span>
                            Ajouter un atelier</h4>
                    </div>
                    <div class="modal-body">
                        {{ form_start(formAtelier) }}
                        {{ form_errors(formAtelier) }}
                        {{ form_row(formAtelier.date, {'attr': {'autocomplete': 'off'} }) }}
                        {{ form_row(formAtelier.thematique) }}
                        {{ form_row(formAtelier.heure) }}
                        {{ form_row(formAtelier.type) }}
                        {{ form_row(formAtelier.accompagnant, {'required': false}) }}
                        {{ form_row(formAtelier.etat) }}
                        {{ form_row(formAtelier.motifRefus, {'required': false}) }}
                        {{ form_row(formAtelier._token) }}
                        {{ form_end(formAtelier, {'render_rest' : false}) }}
                        <button id="atelier_add" class="btn btn-primary btn-block" data-dismiss="modal" disabled="disabled">Ajouter</button>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-default pull-left" data-dismiss="modal">
                            <span class="glyphicon glyphicon-remove"></span>
                            Annuler</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal addTelephonique-->
        <div id="telephoniqueModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-plus"></span>
                            Ajouter un rendez-vous téléphonique</h4>
                    </div>
                    <div class="modal-body">
                        {{ form_start(formTelephonique) }}
                        {{ form_errors(formTelephonique) }}
                        {{ form_row(formTelephonique.date, {'attr': {'autocomplete': 'off'} }) }}
                        {{ form_row(formTelephonique.thematique) }}
                        {{ form_row(formTelephonique.etat) }}
                        {{ form_row(formTelephonique.motifRefus, {'required': false}) }}
                        {{ form_row(formTelephonique._token) }}
                        {{ form_end(formTelephonique, {'render_rest' : false}) }}
                        <button id="telephonique_add" class="btn btn-primary btn-block" data-dismiss="modal" disabled="disabled">Ajouter</button>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-default pull-left" data-dismiss="modal">
                            <span class="glyphicon glyphicon-remove"></span>
                            Annuler</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal addInfos-->
        <div id="infosModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-plus"></span>
                            Ajouter un atelier Infos</h4>
                    </div>
                    <div class="modal-body">
                        {{ form_start(formInfos) }}
                        {{ form_errors(formInfos) }}
                        {{ form_row(formInfos.date, {'attr': {'autocomplete': 'off'} }) }}
                        {{ form_row(formInfos.type) }}
                        {{ form_row(formInfos.accompagnant) }}
                        {{ form_row(formInfos.etat) }}
                        {{ form_row(formInfos.motifRefus, {'required': false}) }}
                        {{ form_row(formInfos._token) }}
                        {{ form_end(formInfos, {'render_rest' : false}) }}
                        <button id="infos_add" class="btn btn-primary btn-block" data-dismiss="modal" disabled="disabled">Ajouter</button>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-default pull-left" data-dismiss="modal">
                            <span class="glyphicon glyphicon-remove"></span>
                            Annuler</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal addBCVs-->
        <div id="bcvsModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-plus"></span>
                            Ajouter un BCVs</h4>
                    </div>
                    <div class="modal-body">
                        {{ form_start(formBCVs) }}
                        {{ form_errors(formBCVs) }}
                        {{ form_row(formBCVs.date, {'attr': {'autocomplete': 'off'} }) }}
                        {{ form_row(formBCVs.accompagnant) }}
                        {{ form_row(formBCVs.permission) }}
                        {{ form_row(formBCVs.etat) }}
                        {{ form_row(formBCVs.motifRefus, {'required': false}) }}
                        {{ form_row(formBCVs._token) }}
                        {{ form_end(formBCVs, {'render_rest' : false}) }}
                        <button id="bcvs_add" class="btn btn-primary btn-block" data-dismiss="modal" disabled="disabled">Ajouter</button>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-default pull-left" data-dismiss="modal">
                            <span class="glyphicon glyphicon-remove"></span>
                            Annuler</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal Suppression-->
        <div id="removeModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            <span class="glyphicon glyphicon-warning"></span>
                            Suppression</h4>
                    </div>
                    <div class="modal-body">
                        <p>Êtes-vous sûr de vouloir supprimer cet élément ?</p>
                        <button class="btn btn-primary btn-block-md" data-dismiss="modal">Oui</button>
                        <button class="btn btn-danger btn-block-md" data-dismiss="modal">Non</button>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-default pull-left" data-dismiss="modal">
                            <span class="glyphicon glyphicon-remove"></span>
                            Annuler</button>
                    </div>

                </div>
            </div>
        </div>

        <a id="timeline_update"></a>
    </div>
{% endblock page_content %}

{% block javascripts %}
    <script src="{{ asset('js/script.js') }}"></script>
    <script type="text/javascript">

        alert_pos = {{ top }};

        function updateForm() {
            $('#timeline_update').trigger('click');
            $('.datepicker').datepicker({language: 'fr', format: 'dd/mm/yyyy', todayBtn: true, todayHighlight: true, autoclose: true});
            changeSelectColor(null);
            sortSelect();
        }
        updateForm();

        {# Set select color #}
        function setSelectColor(obj) {
            let color = obj.find(":selected").attr("class");
            if (!color)
                return;
            obj.css({background: color});
            let index = obj.parents('li').index();
            let dot = obj.parents('.events-content').prev().find('ol li:eq(' + index + ') a');
            if (dot.hasClass('selected'))
                dot.removeClass().addClass('selected');
            else if (dot.hasClass('older-event'))
                dot.removeClass().addClass('older-event');
            else
                dot.removeClass()
            dot.addClass(color + '-after');
        }

        function changeSelectColor(obj)  {
            if (obj)
                setSelectColor(obj)
            else {
                $('section select').each(function () {
                    setSelectColor($(this));
                });
            }
        }

        function changeDotColor() {
            $('cd-horizontal-timeline, events a.selected::after')
        }

        $('ol, .modal').on('change', 'select', function() {
            changeSelectColor($(this));
        });

        {# Set time from select #}
        $("ol, .modal").on("change", ".get-hour", function() {
            let time = $(this).find(":selected").attr("data-hour");
            $(this).parents().eq(2).find(".set-hour").val(time);
        })

        {# Update datetime #}
        var month = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre",]

        function sort_li(a, b){
            return ($(b).find("a").attr('data-date')) < ($(a).find("a").attr('data-date')) ? 1 : -1;    
        }

        $("ol .datepicker").on("change", function() {
            let datetime = $(this).val().split("/");
            $(this).parents("li").find("em").text(parseInt(datetime[0]) + " " + month[parseInt(datetime[1]) - 1] + " " + datetime[2]);
            let index = $(this).parents('li').index();
            let dot = $(this).parents('.events-content').prev().find('ol li:eq(' + index + ') a');
            dot.attr('data-date', $(this).val());
            dot.text(parseInt(datetime[0]) + " " + month[parseInt(datetime[1]) - 1]);
            // $(this).parents('ol').find('li').sort(sort_li).appendTo($(this).parents('ol'));
            // updateForm();
        })

        {# Delete #}

        $('.cd-horizontal-timeline').on("click", ".btn-danger", function () {
            $("#removeModal").modal()
            var btn = $(this);
            $('#removeModal .btn-primary').on('click', function () {
                var num = btn.closest('li').index();
                var timeline = btn.parents('.cd-horizontal-timeline');
                var date = btn.parents('li').find('.datepicker').val();

                timeline.find('ol').each(function () {
                    $(this).find('li:nth-child(' + (num + 1) + ')').remove();
                });
                timeline.find('.events li a').removeClass("selected").addClass("older-event");
                timeline.find('.events li:last-child a').removeClass("older-event").addClass("selected");
                timeline.find('.events-content li').removeClass("selected");
                timeline.find('.events-content li:last-child').addClass("selected");
                $('#timeline_update').trigger('click');

                if (timeline.is('#timeline-entretiens')) {
                    var id = btn.parents('li').find('.datepicker').attr("name").match(/\d+/)[0];
                    var url = "{{ path( 'entretien_remove', { 'id': 'entretien_id' }) }}";
                    url = url.replace("entretien_id", id);
                    $.ajax({url: url, type: "DELETE", success: function (resp) {}});
                } else if (timeline.is('#timeline-ateliers')) {
                    var id = btn.parents('li').find('.datepicker').attr("name").match(/\d+/)[0];
                    var url = "{{ path( 'atelier_remove', { 'id': 'atelier_id' }) }}";
                    url = url.replace("atelier_id", id);
                    $.ajax({url: url, type: "DELETE", success: function (resp) {}});
                } else if (timeline.is('#timeline-telephoniques')) {
                    var id = btn.parents('li').find('.datepicker').attr("name").match(/\d+/)[0];
                    var url = "{{ path( 'telephonique_remove', { 'id': 'telephonique_id' }) }}";
                    url = url.replace("telephonique_id", id);
                    $.ajax({url: url, type: "DELETE", success: function (resp) {}});
                } else if (timeline.is('#timeline-rendezVous')) {
                    var id = btn.parents('li').find('.datepicker').attr("name").match(/\d+/)[0];
                    var url = "{{ path( 'rendezVous_remove', { 'id': 'rendezVous_id' }) }}";
                    url = url.replace("rendezVous_id", id);
                    $.ajax({url: url, type: "DELETE", success: function (resp) {}});
                } else if (timeline.is('#timeline-bcvs')) {
                    var id = btn.parents('li').find('.datepicker').attr("name").match(/\d+/)[0];
                    var url = "{{ path( 'bcvs_remove', { 'id': 'bcvs_id' }) }}";
                    url = url.replace("bcvs_id", id);
                    $.ajax({url: url, type: "DELETE", success: function (resp) {}});
                } else if (timeline.is('#timeline-infos')) {
                    var id = btn.parents('li').find('.datepicker').attr("name").match(/\d+/)[0];
                    var url = "{{ path( 'infos_remove', { 'id': 'infos_id' }) }}";
                    url = url.replace("infos_id", id);
                    $.ajax({url: url, type: "DELETE", success: function (resp) {}});
                }
                $('body').prepend(
                    '<div class="row alert alert-success text-center box-shadow" style="top:' + alert_pos + 'px;"><span class="closebtn" onclick="this.parentElement.style.display=\'none\';">&times;</span>Suppression effectuée !</div>'
                );
                alert_pos += 72;
            });
        });

        /* BCVs
		================= */

        {# Edit #}

        $("#events-content-bcvs").on("click", ".btn-primary", function () {
            var arr = [], i = 0;
            $(this).parents("li").find("input, select").each(function() {
                arr[i++] = $(this).val();
            })
            var id = $(this).parents("li").find('input').attr('id').match(/\d+/)[0];
            var url = "{{ path('bcvs_patch', { 'id': 'bcvs_id' }) }}";
            url = url.replace("bcvs_id", id);

            $.ajax({
                url: url,
                type: "POST",
                dataType: "json",
                data: {
                    "date": arr[0],
                    "accompagnant": arr[1],
                    "permission": arr[2],
                    "etat": arr[3],
                    "motifRefus": arr[4]
                },
                success: function (resp) {
                    $('body').prepend(
                        '<div class="row alert alert-success text-center box-shadow" style="top:' + alert_pos + 'px;"><span class="closebtn" onclick="this.parentElement.style.display=\'none\';">&times;</span>Modification effectuée !</div>'
                    );
                    alert_pos += 72;
                }
            });
        })

        {# Error date add #}

        $("#bc_vs_date").change(function () {
            resetErrors();
            var date = $(this).val();
            $.ajax({
                url: "{{ path( 'bcvs_date_error' ) }}",
                type: "POST",
                dataType: "json",
                data: {
                    "date": date,
                    "id": '{{ patient.id }}'
                },
                success: function (resp) {
                    if (resp) {
                        var msg = '<span class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Error</span> <span class="form-error-message">La date est antérieure à un précédent rendez-vous ou à aujourd\'hui</span></span></span>';
                        $("#bc_vs_date").addClass('is-invalid').after(msg);
                        document.getElementById("bcvs_add").disabled = true;
                    } else {
                        document.getElementById("bcvs_add").disabled = false;
                    }
                }
            });
        });

        {# Add #}

        $("#bcvs_add").on('click', function () {
            let date = $('#bc_vs_date').val();
            let accompagnant = $('#bc_vs_accompagnant').val();
            let permission = $('#bc_vs_permission').val();
            let etat = $('#bc_vs_etat').val();
            let motifRefus = $('#bc_vs_motifRefus').val();

            $.ajax({
                url: "{{ path('bcvs_add') }}",
                type: "POST",
                dataType: "json",
                data: {
                    "id": '{{ patient.id }}',
                    "date": date,
                    "accompagnant": accompagnant,
                    "permission": permission,
                    "etat": etat,
                    "motifRefus": motifRefus
                },
                success: function (resp) {
                    if (resp) {
                        var new_date = new Date(formatDate(date));
                        var date_h1 = new Intl.DateTimeFormat("fr-FR", {
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var date_em = new Intl.DateTimeFormat("fr-FR", {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var nb = $("#events-content-bcvs").find('li').length;
                        var events = $('#events-bcvs');
                        $('#events-bcvs li a').removeClass("selected");
                        $('#events-bcvs li a').addClass("older-event");
                        $(document.createElement('li'))
                            .append('<a href=\"#0\" data-date=' + date + '>' + date_h1 + '</a>')
                            .appendTo(events);
                        $('#events-bcvs li:last-child a').addClass('selected');
                        $('#events-bcvs li:last-child a').removeClass('older-event');

                        var events_content = $('#events-content-bcvs');
                        $('#events-content-bcvs li').removeClass("selected");
                        $(events_content)
                            .append(`<li data-date=` + date + `>
                                        <h2>BCVs ` + (nb + 1) + `</h2>
                                        <em>` + date_em + `</em>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label required" for="patient_creation_form_bcvs_` + resp + `_date">Date prévue</label><input type="text" id="patient_creation_form_bcvs_` + resp + `_date" name="patient_creation_form[bcvs][` + resp + `][date]" required="required" class="datepicker form-control" value="` + date + `"></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_bcvs_` + resp + `_accompagnant">Accompagnant</label><select id="patient_creation_form_bcvs_` + resp + `_accompagnant" name="patient_creation_form[bcvs][` + resp + `][accompagnant]" class="form-control"><option value=""></option><option value="Oui" selected="selected">Oui</option><option value="Non">Non</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_bcvs_` + resp + `_permission">Permission demandée</label><select id="patient_creation_form_bcvs_` + resp + `_permission" name="patient_creation_form[bcvs][` + resp + `][permission]" class="form-control"><option value=""></option><option value="Oui 1 nuit">Oui 1 nuit</option><option value="Oui 2 nuits" selected="selected">Oui 2 nuits</option><option value="Non">Non</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_bcvs_` + resp + `_etat">A-t-il eu lieu ?</label><select id="patient_creation_form_bcvs_` + resp + `_etat" name="patient_creation_form[bcvs][` + resp + `][etat]" class="form-control" style="background: hotpink;"><option value="" class="white"></option><option value="Oui" class="hotpink" selected="selected">Oui</option><option value="Non" class="yellow">Non</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                        <label class="control-label" for="patient_creation_form_bcvs_` + resp + `_motifRefus">Motif de refus</label><input type="text" id="patient_creation_form_bcvs_` + resp + `_motifRefus" name="patient_creation_form[bcvs][` + resp + `][motifRefus]" class="form-control"></div>
                                        </div>
                                        <div class="row">
                                            <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                            <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                        </div>
                                    </li>`)
                            .appendTo(events_content);
                        $('#patient_creation_form_bc_vs_' + resp + '_permission').val(permission);
                        $('#patient_creation_form_bc_vs_' + resp + '_accompagnant').val(accompagnant);
                        $('#patient_creation_form_bc_vs_' + resp + '_etat').val(etat);
                        $('#events-content-bcvs li:last-child').addClass('selected');

                        updateForm();
                        document.getElementById("bcvs_add").disabled = true;
                    }
                }
            });
        });

        /* Infos
		================= */

        {# Edit #}

        $("#events-content-infos").on("click", ".btn-primary", function () {
            var arr = [], i = 0;
            $(this).parents("li").find("input, select").each(function() {
                arr[i++] = $(this).val();
            })
            var id = $(this).parents("li").find('input').attr('id').match(/\d+/)[0];
            var url = "{{ path('infos_patch', { 'id': 'infos_id' }) }}";
            url = url.replace("infos_id", id);

            $.ajax({
                url: url,
                type: "POST",
                dataType: "json",
                data: {
                    "date": arr[0],
                    "type": arr[1],
                    "accompagnant": arr[2],
                    "etat": arr[3],
                    "motifRefus": arr[4]
                },
                success: function (resp) {
                    $('body').prepend(
                        '<div class="row alert alert-success text-center box-shadow" style="top:' + alert_pos + 'px;"><span class="closebtn" onclick="this.parentElement.style.display=\'none\';">&times;</span>Modification effectuée !</div>'
                    );
                    alert_pos += 72;
                }
            });
        })

        {# Error date add #}

        $("#infos_date").change(function () {
            resetErrors();
            var date = $(this).val();
            $.ajax({
                url: "{{ path( 'infos_date_error' ) }}",
                type: "POST",
                dataType: "json",
                data: {
                    "date": date,
                    "id": '{{ patient.id }}'
                },
                success: function (resp) {
                    if (resp) {
                        var msg = '<span class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Error</span> <span class="form-error-message">La date est antérieure à un précédent rendez-vous ou à aujourd\'hui</span></span></span>';
                        $("#infos_date").addClass('is-invalid').after(msg);
                        document.getElementById("infos_add").disabled = true;
                    } else {
                        document.getElementById("infos_add").disabled = false;
                    }
                }
            });
        });

        {# Add #}

        $("#infos_add").on('click', function () {
            let date = $('#infos_date').val();
            let type = $('#infos_type').val();
            let accompagnant = $('#infos_accompagnant').val();
            let etat = $('#infos_etat').val();
            let motifRefus = $('#infos_motifRefus').val();

            $.ajax({
                url: "{{ path('infos_add') }}",
                type: "POST",
                dataType: "json",
                data: {
                    "id": '{{ patient.id }}',
                    "date": date,
                    "type": type,
                    "accompagnant": accompagnant,
                    "etat": etat,
                    "motifRefus": motifRefus
                },
                success: function (resp) {
                    if (resp) {
                        var new_date = new Date(formatDate(date));
                        var date_h1 = new Intl.DateTimeFormat("fr-FR", {
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var date_em = new Intl.DateTimeFormat("fr-FR", {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var nb = $("#events-content-infos").find('li').length;
                        var events = $('#events-infos');
                        $('#events-infos li a').removeClass("selected");
                        $('#events-infos li a').addClass("older-event");
                        $(document.createElement('li'))
                            .append('<a href=\"#0\" data-date=' + date + '>' + date_h1 + '</a>')
                            .appendTo(events);
                        $('#events-infos li:last-child a').addClass('selected');
                        $('#events-infos li:last-child a').removeClass('older-event');

                        var events_content = $('#events-content-infos');
                        $('#events-content-infos li').removeClass("selected");
                        $(events_content)
                            .append(`<li data-date=` + date + `>
                                        <h2>Atelier Infos ` + (nb + 1) + `</h2>
                                        <em>` + date_em + `</em>
                                <div class="row"><div class="form-group">
                                    <label class="control-label required" for="patient_creation_form_infos_` + resp + `_date">Date prévue</label><input type="text" id="patient_creation_form_infos_` + resp + `_date" name="patient_creation_form[infos][` + resp + `][date]" required="required" class="datepicker form-control" value="` + date + `"></div>
                                </div>
                                <div class="row"><div class="form-group">
                                    <label class="control-label" for="patient_creation_form_infos_` + resp + `_type">Type</label><select id="patient_creation_form_infos_` + resp + `_type" name="patient_creation_form[infos][` + resp + `][type]" class="form-control"><option value=""></option><option value="Ambu">Ambu</option><option value="Tel" selected="selected">Tel</option><option value="Hospit">Hospit</option></select></div>
                                </div>
                                <div class="row"><div class="form-group">
                                    <label class="control-label" for="patient_creation_form_infos_` + resp + `_accompagnant">Accompagnant</label><select id="patient_creation_form_infos_` + resp + `_accompagnant" name="patient_creation_form[infos][` + resp + `][accompagnant]" class="form-control"><option value=""></option><option value="Oui">Oui</option><option value="Non" selected="selected">Non</option></select></div>
                                </div>
                                <div class="row"><div class="form-group">
                                    <label class="control-label" for="patient_creation_form_infos_` + resp + `_etat">A-t-il eu lieu ?</label><select id="patient_creation_form_infos_` + resp + `_etat" name="patient_creation_form[infos][` + resp + `][etat]" class="form-control" style="background: hotpink;"><option value="" class="white"></option><option value="Oui" class="hotpink" selected="selected">Oui</option><option value="Non" class="yellow">Non</option></select></div>
                                </div>
                                <div class="row"><div class="form-group">
                                    <label class="control-label" for="patient_creation_form_infos_` + resp + `_motifRefus">Motif de refus</label><input type="text" id="patient_creation_form_infos_` + resp + `_motifRefus" name="patient_creation_form[infos][` + resp + `][motifRefus]" class="form-control"></div>
                                </div>
                                <div class="row">
                                    <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                    <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                </div>
                            </li>`)
                            .appendTo(events_content);
                        $('#patient_creation_form_infos_' + resp + '_type').val(type);
                        $('#patient_creation_form_infos_' + resp + '_accompagnant').val(accompagnant);
                        $('#patient_creation_form_infos_' + resp + '_etat').val(etat);
                        $('#events-content-infos li:last-child').addClass('selected');

                        updateForm();
                        document.getElementById("infos_add").disabled = true;
                    }
                }
            });
        });

        /* Ateliers
		================= */

        {# Edit #}

        $("#events-content-ateliers").on("click", ".btn-primary", function () {
            var arr = [], i = 0;
            $(this).parents("li").find("input, select").each(function() {
                arr[i++] = $(this).val();
            })
            var id = $(this).parents("li").find('input').attr('id').match(/\d+/)[0];
            var url = "{{ path('atelier_patch', { 'id': 'atelier_id' }) }}";
            url = url.replace("atelier_id", id);

            $.ajax({
                url: url,
                type: "POST",
                dataType: "json",
                data: {
                    "date": arr[0],
                    "thematique": arr[1],
                    "time": arr[2],
                    "type": arr[3],
                    "accompagnant": arr[4],
                    "etat": arr[5],
                    "motifRefus": arr[6]
                },
                success: function (resp) {
                    $('body').prepend(
                        '<div class="row alert alert-success text-center box-shadow" style="top:' + alert_pos + 'px;"><span class="closebtn" onclick="this.parentElement.style.display=\'none\';">&times;</span>Modification effectuée !</div>'
                    );
                    alert_pos += 72;
                }
            });
        })

        {# Error date add #}

        $("#atelier_date").change(function () {
            resetErrors();
            var date = $(this).val();
            $.ajax({
                url: "{{ path( 'atelier_date_error' ) }}",
                type: "POST",
                dataType: "json",
                data: {
                    "date": date,
                    "id": '{{ patient.id }}'
                },
                success: function (resp) {
                    if (resp) {
                        var msg = '<span class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Error</span> <span class="form-error-message">La date est antérieure à un précédent rendez-vous ou à aujourd\'hui</span></span></span>';
                        $("#atelier_date").addClass('is-invalid').after(msg);
                        document.getElementById("atelier_add").disabled = true;
                    } else {
                        document.getElementById("atelier_add").disabled = false;
                    }
                }
            });
        });

        {# Add #}

        $("#atelier_add").on('click', function () {
            let date = $('#atelier_date').val();
            let thematique = $('#atelier_thematique').val();
            let time = $('#atelier_heure').val();
            let type = $('#atelier_type').val();
            let accompagnant = $('#atelier_accompagnant').val();
            let etat = $('#atelier_etat').val();
            let motifRefus = $('#atelier_motifRefus').val();

            $.ajax({
                url: "{{ path('atelier_add') }}",
                type: "POST",
                dataType: "json",
                data: {
                    "id": '{{ patient.id }}',
                    "date": date,
                    "thematique": thematique,
                    "time": time,
                    "type": type,
                    "accompagnant": accompagnant,
                    "etat": etat,
                    "motifRefus": motifRefus
                },
                success: function (resp) {
                    if (resp) {
                        var new_date = new Date(formatDate(date));
                        var date_h1 = new Intl.DateTimeFormat("fr-FR", {
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var date_em = new Intl.DateTimeFormat("fr-FR", {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var nb = $("#events-content-ateliers").find('li').length;
                        var events = $('#events-ateliers');
                        $('#events-ateliers li a').removeClass("selected");
                        $('#events-ateliers li a').addClass("older-event");
                        $(document.createElement('li'))
                            .append('<a href=\"#0\" data-date=' + date + '>' + date_h1 + '</a>')
                            .appendTo(events);
                        $('#events-ateliers li:last-child a').addClass('selected');
                        $('#events-ateliers li:last-child a').removeClass('older-event');

                        var events_content = $('#events-content-ateliers');
                        $('#events-content-ateliers li').removeClass("selected");
                        $(events_content)
                            .append(`<li data-date=` + date + `>
                                        <h2>Atelier ` + (nb + 1) + `</h2>
                                        <em>` + date_em + `</em>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label required" for="patient_creation_form_ateliers_` + resp + `_date">Date</label>
                                            <input type="text" id="patient_creation_form_ateliers_` + resp + `_date" name="patient_creation_form[ateliers][` + resp + `][date]" required="required" class="datepicker form-control" value="` + date + `">
                                        </div></div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_ateliers_` + resp + `_thematique">Thématique</label><select id="patient_creation_form_ateliers_` + resp + `_thematique" name="patient_creation_form[ateliers][` + resp + `][thematique]" class="get-hour form-control"><option value=""></option><option value="Signes d'alerte" data-hour="15:00">Signes d'alerte</option><option value="Gestion du stress" data-hour="13:30">Gestion du stress</option><option value="Cuisine Poisson" data-hour="10:00">Cuisine Poisson</option><option value="Cuisine MG" data-hour="10:00">Cuisine MG</option><option value="Cuisine F&amp;L" data-hour="10:00">Cuisine F&amp;L</option><option value="Gestion des sucres" data-hour="14:00">Gestion des sucres</option><option value="Gestion des quantités" data-hour="12:00">Gestion des quantités</option><option value="Freins/solutions équilibre" data-hour="14:00">Freins/solutions équilibre</option><option value="Stress aigu" data-hour="14:00">Stress aigu</option><option value="Prévention stress" data-hour="14:00">Prévention stress</option><option value="Communication" data-hour="14:00">Communication</option><option value="Marche co 1" data-hour="14:00">Marche co 1</option><option value="Marche co 2" data-hour="14:00">Marche co 2</option></select></div>
                                        </div>
                                            <div class="row"><div class="form-group"><label class="control-label" for="patient_creation_form_ateliers_` + resp + `_heure">Heure</label><select id="patient_creation_form_ateliers_` + resp + `_heure" name="patient_creation_form[ateliers][` + resp + `][heure]" class="set-hour form-control"><option value=""></option><option value="10:00">10:00</option><option value="12:00">12:00</option><option value="13:30">13:30</option><option value="14:00" selected="selected">14:00</option><option value="15:00">15:00</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_ateliers_` + resp + `_type">Type</label><select id="patient_creation_form_ateliers_` + resp + `_type" name="patient_creation_form[ateliers][` + resp + `][type]" class="form-control"><option value=""></option><option value="Ambu">Ambu</option><option value="Hospit">Hospit</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_ateliers_` + resp + `_accompagnant">Accompagnant</label><select id="patient_creation_form_ateliers_` + resp + `_accompagnant" name="patient_creation_form[ateliers][` + resp + `][accompagnant]" class="form-control"><option value=""></option><option value="oui">Oui</option><option value="non">Non</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_ateliers_` + resp + `_etat">Est-il/elle venu(e) ?</label><select id="patient_creation_form_ateliers_` + resp + `_etat" name="patient_creation_form[ateliers][` + resp + `][etat]" class="form-control" style="background: hotpink;"><option value="" class="white"></option><option value="Oui" class="hotpink">Oui</option><option value="Non" class="yellow">Non</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_ateliers_` + resp + `_motifRefus">Motif de refus</label><input type="text" id="patient_creation_form_ateliers_` + resp + `_motifRefus" name="patient_creation_form[ateliers][` + resp + `][motifRefus]" class="form-control" value=` + motifRefus + `></div>
                                        </div>
                                        <div class="row">
                                            <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                            <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                        </div>
                                    </li>`)
                            .appendTo(events_content);
                        $('#patient_creation_form_ateliers_' + resp + '_thematique').val(thematique);
                        $('#patient_creation_form_ateliers_' + resp + '_heure').val(time);
                        $('#patient_creation_form_ateliers_' + resp + '_type').val(type);
                        $('#patient_creation_form_ateliers_' + resp + '_accompagnant').val(accompagnant);
                        $('#patient_creation_form_ateliers_' + resp + '_etat').val(etat);
                        $('#events-content-ateliers li:last-child').addClass('selected');

                        updateForm();
                        document.getElementById("atelier_add").disabled = true;
                    }
                }
            });
        });

        /* Telephoniques
		================= */

        {# Edit #}

        $("#events-content-telephoniques").on("click", ".btn-primary", function () {
            var arr = [], i = 0;
            $(this).parents("li").find("input, select").each(function() {
                arr[i++] = $(this).val();
            })
            var id = $(this).parents("li").find('input').attr('id').match(/\d+/)[0];
            var url = "{{ path('telephonique_patch', { 'id': 'telephonique_id' }) }}";
            url = url.replace("telephonique_id", id);
            var date = arr[0];
            var thematique = arr[1];
            var etat = arr[2];
            var motifRefus = arr[3];

            $.ajax({
                url: url,
                type: "POST",
                dataType: "json",
                data: {
                    "date": date,
                    "thematique": thematique,
                    "etat": etat,
                    "motifRefus": motifRefus
                },
                success: function (resp) {
                    $('body').prepend(
                        '<div class="row alert alert-success text-center box-shadow" style="top:' + alert_pos + 'px;"><span class="closebtn" onclick="this.parentElement.style.display=\'none\';">&times;</span>Modification effectuée !</div>'
                    );
                    alert_pos += 72;
                }
            });
        })

        {# Error date add #}

        $("#telephonique_date").change(function () {
            resetErrors();
            var date = $(this).val();
            $.ajax({
                url: "{{ path( 'telephonique_date_error' ) }}",
                type: "POST",
                dataType: "json",
                data: {
                    "date": date,
                    "id": '{{ patient.id }}'
                },
                success: function (resp) {
                    if (resp) {
                        var msg = '<span class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Error</span> <span class="form-error-message">La date est antérieure à un précédent rendez-vous ou à aujourd\'hui</span></span></span>';
                        $("#telephonique_date").addClass('is-invalid').after(msg);
                        document.getElementById("telephonique_add").disabled = true;
                    } else {
                        document.getElementById("telephonique_add").disabled = false;
                    }
                }
            });
        });

        {# Add #}

        $("#telephonique_add").on('click', function () {
            var date = $('#telephonique_date').val();
            var thematique = $('#telephonique_thematique').val();
            var etat = $('#telephonique_etat').val();
            var motifRefus = $('#telephonique_motifRefus').val();

            $.ajax({
                url: "{{ path('telephonique_add') }}",
                type: "POST",
                dataType: "json",
                data: {
                    "id": '{{ patient.id }}',
                    "date": date,
                    "thematique": thematique,
                    "etat": etat,
                    "motifRefus": motifRefus
                },
                success: function (resp) {
                    if (resp) {
                        var new_date = new Date(formatDate(date));
                        var date_h1 = new Intl.DateTimeFormat("fr-FR", {
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var date_em = new Intl.DateTimeFormat("fr-FR", {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var nb = $("#events-content-telephoniques").find('li').length;
                        var events = $('#events-telephoniques');
                        $('#events-telephoniques li a').removeClass("selected");
                        $('#events-telephoniques li a').addClass("older-event");
                        $(document.createElement('li'))
                            .append('<a href=\"#0\" data-date=' + date + '>' + date_h1 + '</a>')
                            .appendTo(events);
                        $('#events-telephoniques li:last-child a').addClass('selected');
                        $('#events-telephoniques li:last-child a').removeClass('older-event');

                        var events_content = $('#events-content-telephoniques');
                        $('#events-content-telephoniques li').removeClass("selected");
                        $(events_content)
                            .append(`<li data-date=` + date + `>
                                        <h2>Rendez-vous téléphonique ` + (nb + 1) + `</h2><em>` + date_em + `</em>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label required" for="patient_creation_form_telephoniques_` + resp + `_date">Date</label>
                                            <input type="text" id="patient_creation_form_telephoniques_` + resp + `_date" name="patient_creation_form[telephoniques][` + resp + `][date]" required="required" class="datepicker form-control" value="` + date + `">
                                        </div></div>

                                        <div class="row"><div class="form-group">
                                            <label class="control-label required" for="patient_creation_form_telephoniques_` + resp + `_thematique">Thématique</label>
                                            <select id="patient_creation_form_telephoniques_` + resp + `_thematique" name="patient_creation_form[telephoniques][` + resp + `][thematique]" class="form-control">
                                                <option value="Motivationnel">Motivationnel</option>    
                                                <option value="Coaching tabac">Coaching tabac</option>
                                                <option value="Coaching AOMI">Coaching AOMI</option>
                                            </select>
                                        </div></div>

                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_telephoniques_` + resp + `_etat">A-t-il eu lieu ?</label>
                                            <select id="patient_creation_form_telephoniques_` + resp + `_etat" name="patient_creation_form[telephoniques][` + resp + `][etat]" class="form-control">
                                                <option value=""></option><option value="Oui" class="hotpink">Oui</option>
                                                <option value="Non" class="yellow">Non</option>
                                            </select>
                                        </div></div>

                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_telephoniques_` + resp + `_motifRefus">Motif de refus</label>
                                            <input type="text" id="patient_creation_form_telephoniques_` + resp + `_motifRefus" name="patient_creation_form[telephoniques][` + resp + `][motifRefus]" class="form-control" value=` + motifRefus + `>
                                        </div></div>

                                        <div class="row">
                                            <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                            <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                        </div>
                                     </li>
                                    `)
                            .appendTo(events_content);
                        $('#patient_creation_form_telephoniques_' + resp + '_thematique').val(thematique);
                        $('#patient_creation_form_telephoniques_' + resp + '_etat').val(etat);
                        $('#events-content-telephoniques li:last-child').addClass('selected');

                        updateForm();
                        document.getElementById("telephonique_add").disabled = true;
                    }
                }
            });
        });

        /* Entretiens
		================= */

        {# Edit #}

        $("#events-content-entretiens").on("click", ".btn-primary", function () {
            var arr = [], i = 0;
            $(this).parents("li").find("input, select").each(function() {
                arr[i++] = $(this).val();
            })
            var id = $(this).parents("li").find('input').attr('id').match(/\d+/)[0];
            var url = "{{ path('entretien_patch', { 'id': 'entretien_id' }) }}";
            url = url.replace("entretien_id", id);

            $.ajax({
                url: url,
                type: "POST",
                dataType: "json",
                data: {
                    "date": arr[0],
                    "thematique": arr[1],
                    "time": arr[2],
                    "type": arr[3],
                    "accompagnant": arr[4],
                    "etat": arr[5],
                    "motifRefus": arr[6]
                },
                success: function (resp) {
                    $('body').prepend(
                        '<div class="row alert alert-success text-center box-shadow" style="top:' + alert_pos + 'px;"><span class="closebtn" onclick="this.parentElement.style.display=\'none\';">&times;</span>Modification effectuée !</div>'
                    );
                    alert_pos += 72;
                }
            });
        })

        {# Error date add #}

        $("#entretien_date").change(function () {
            resetErrors();
            var date = $(this).val();
            $.ajax({
                url: "{{ path( 'entretien_date_error' ) }}",
                type: "POST",
                dataType: "json",
                data: {
                    "date": date,
                    "id": '{{ patient.id }}'
                },
                success: function (resp) {
                    if (resp) {
                        var msg = '<span class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Error</span> <span class="form-error-message">La date est antérieure à un précédent rendez-vous ou à aujourd\'hui</span></span></span>';
                        $("#entretien_date").addClass('is-invalid').after(msg);
                        document.getElementById("entretien_add").disabled = true;
                    } else {
                        document.getElementById("entretien_add").disabled = false;
                    }
                }
            });
        });

        {# Add #}

        $("#entretien_add").on('click', function () {
            var date = $('#entretien_date').val();
            var thematique = $('#entretien_thematique').val();
            var time = $('#entretien_heure').val();
            var type = $('#entretien_type').val();
            var accompagnant = $('#entretien_accompagnant').val();
            var etat = $('#entretien_etat').val();
            var motifRefus = $('#entretien_motifRefus').val();

            $.ajax({
                url: "{{ path('entretien_add') }}",
                type: "POST",
                dataType: "json",
                data: {
                    "id": '{{ patient.id }}',
                    "date": date,
                    "thematique": thematique,
                    "time": time,
                    "type": type,
                    "accompagnant": accompagnant,
                    "etat": etat,
                    "motifRefus": motifRefus
                },
                success: function (resp) {
                    if (resp) {
                        var new_date = new Date(formatDate(date));
                        var date_h1 = new Intl.DateTimeFormat("fr-FR", {
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var date_em = new Intl.DateTimeFormat("fr-FR", {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var nb = $("#events-content-entretiens").find('li').length;
                        var events = $('#events-entretiens');
                        $('#events-entretiens li a').removeClass("selected");
                        $('#events-entretiens li a').addClass("older-event");
                        $(document.createElement('li'))
                            .append('<a href=\"#0\" data-date=' + date + '>' + date_h1 + '</a>')
                            .appendTo(events);
                        $('#events-entretiens li:last-child a').addClass('selected');
                        $('#events-entretiens li:last-child a').removeClass('older-event');

                        var events_content = $('#events-content-entretiens');
                        $('#events-content-entretiens li').removeClass("selected");
                        $(events_content)
                            .append(`<li data-date=` + date + `>
                                        <h2>Entretien individuel ` + (nb + 1) + `</h2>
                                        <em>` + date_em + `</em><div class="row">
                                        <div class="row"><div class="form-group">
                                            <label class="control-label required" for="patient_creation_form_entretiens_` + resp + `_date">Date prévue</label><input type="text" id="patient_creation_form_entretiens_` + resp + `_date" name="patient_creation_form[entretiens][` + resp + `][date]" required="required" class="datepicker form-control" value="` + date + `"></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label required" for="patient_creation_form_entretiens_` + resp + `_thematique">Thématique</label><select id="patient_creation_form_entretiens_` + resp + `_thematique" name="patient_creation_form[entretiens][` + resp + `][thematique]" required="required" class="form-control"><option value=""></option><option value="Maladie et FDR">Maladie et FDR</option><option value="Diabète">Diabète</option><option value="Signes alerte et CAT">Signes alerte et CAT</option><option value="Motivationnel">Motivationnel</option><option value="M3">M3</option><option value="M12">M12</option><option value="Renf 1">Renf 1</option><option value="Renf 2">Renf 2</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_entretiens_` + resp + `_heure">Heure</label><select id="patient_creation_form_entretiens_` + resp + `_heure" name="patient_creation_form[entretiens][` + resp + `][heure]" class="form-control"><option value=""></option><option value="09:15">09:15</option><option value="10:15">10:15</option><option value="10:30">10:30</option><option value="11:30">11:30</option><option value="11:45">11:45</option><option value="13:30">13:30</option><option value="14:30">14:30</option><option value="14:45">14:45</option><option value="16:00">16:00</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label required" for="patient_creation_form_entretiens_` + resp + `_type">Type</label><select id="patient_creation_form_entretiens_` + resp + `_type" name="patient_creation_form[entretiens][` + resp + `][type]" required="required" class="form-control"><option value=""></option><option value="Diet">Diet</option><option value="Renf1">Renf1</option><option value="Renf2">Renf2</option><option value="Reactu DE">Reactu DE</option><option value="Tabac">Tabac</option><option value="Psy">Psy</option><option value="Diabete">Diabète</option><option value="HTA">HTA</option><option value="Autre">Autre</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_entretiens_` + resp + `_accompagnant">Accompagnant</label><select id="patient_creation_form_entretiens_` + resp + `_accompagnant" name="patient_creation_form[entretiens][` + resp + `][accompagnant]" class="form-control"><option value=""></option><option value="oui">Oui</option><option value="non">Non</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_entretiens_` + resp + `_etat">A-t-il eu lieu ?</label><select id="patient_creation_form_entretiens_` + resp + `_etat" name="patient_creation_form[entretiens][` + resp + `][etat]" class="form-control" style="background: hotpink;"><option value="" class="white"></option><option value="Oui" class="hotpink">Oui</option><option value="Non" class="yellow">Non</option></select></div>
                                        </div>
                                        <div class="row"><div class="form-group">
                                            <label class="control-label" for="patient_creation_form_entretiens_` + resp + `_motifRefus">Motif de refus</label><input type="text" id="patient_creation_form_entretiens_` + resp + `_motifRefus" name="patient_creation_form[entretiens][` + resp + `][motifRefus]" class="form-control"></div>
                                        </div>
                                        <div class="row">
                                            <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                            <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                        </div>
                                    </li>`)
                            .appendTo(events_content);
                        $('#patient_creation_form_entretiens_' + resp + '_thematique').val(thematique);
                        $('#patient_creation_form_entretiens_' + resp + '_heure').val(time);
                        $('#patient_creation_form_entretiens_' + resp + '_type').val(type);
                        $('#patient_creation_form_entretiens_' + resp + '_accompagnant').val(accompagnant);
                        $('#patient_creation_form_entretiens_' + resp + '_etat').val(etat);
                        $('#events-content-entretiens li:last-child').addClass('selected');

                        updateForm();
                        document.getElementById("entretien_add").disabled = true;
                    }
                }
            });
        });

        /* RendezVous
		================= */

        {# Edit #}

        $("#events-content-rendezVous").on("click", ".btn-primary", function () {
            var arr = [], i = 0;
            $(this).parents("li").find("input, select").each(function() {
                arr[i++] = $(this).val();
            })
            var id = $(this).parents("li").find('input').attr('id').match(/\d+/)[0];
            var url = "{{ path('rendezVous_patch', { 'id': 'rendezVous_id' }) }}";
            url = url.replace("rendezVous_id", id);

            $.ajax({
                url: url,
                type: "POST",
                dataType: "json",
                data: {
                    "date": arr[0],
                    "thematique": arr[1],
                    "time": arr[2],
                    "type": arr[3],
                    "accompagnant": arr[4],
                    "etat": arr[5],
                    "motifRefus": arr[6]
                },
                success: function (resp) {
                    $('body').prepend(
                        '<div class="row alert alert-success text-center box-shadow" style="top:' + alert_pos + 'px;"><span class="closebtn" onclick="this.parentElement.style.display=\'none\';">&times;</span>Modification effectuée !</div>'
                    );
                    alert_pos += 72;
                }
            });
        })

        {# Error date add #}

        $("#rendez_vous_date").change(function () {
            resetErrors();
            var date = $(this).val();
            $.ajax({
                url: "{{ path( 'rendezVous_date_error' ) }}",
                type: "POST",
                dataType: "json",
                data: {
                    "date": date,
                    "id": '{{ patient.id }}'
                },
                success: function (resp) {
                    if (resp) {
                        var msg = '<span class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Error</span> <span class="form-error-message">La date est antérieure à un précédent rendez-vous ou à aujourd\'hui</span></span></span>';
                        $("#rendez_vous_date").addClass('is-invalid').after(msg);
                        document.getElementById("rendezVous_add").disabled = true;
                    } else {
                        document.getElementById("rendezVous_add").disabled = false;
                    }
                }
            });
        });

        {# Add #}

        $("#rendezVous_add").on('click', function () {
            let date = $('#rendez_vous_date').val();
            let thematique = $('#rendez_vous_thematique').val();
            let time = $('#rendez_vous_heure').val();
            let type = $('#rendez_vous_type').val();
            let accompagnant = $('#rendez_vous_accompagnant').val();
            let etat = $('#rendez_vous_etat').val();
            let motifRefus = $('#rendez_vous_motifRefus').val();

            $.ajax({
                url: "{{ path('rendezVous_add') }}",
                type: "POST",
                dataType: "json",
                data: {
                    "id": '{{ patient.id }}',
                    "date": date,
                    "thematique": thematique,
                    "time": time,
                    "type": type,
                    "accompagnant": accompagnant,
                    "etat": etat,
                    "motifRefus": motifRefus
                },
                success: function (resp) {
                    if (resp) {
                        var new_date = new Date(formatDate(date));
                        var date_h1 = new Intl.DateTimeFormat("fr-FR", {
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var date_em = new Intl.DateTimeFormat("fr-FR", {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }).format(new_date);
                        var nb = $("#events-content-rendezVous").find('li').length;
                        var events = $('#events-rendezVous');
                        $('#events-rendezVous li a').removeClass("selected");
                        $('#events-rendezVous li a').addClass("older-event");
                        $(document.createElement('li'))
                            .append('<a href=\"#0\" data-date=' + date + '>' + date_h1 + '</a>')
                            .appendTo(events);
                        $('#events-rendezVous li:last-child a').addClass('selected');
                        $('#events-rendezVous li:last-child a').removeClass('older-event');

                        var events_content = $('#events-content-rendezVous');
                        $('#events-content-rendezVous li').removeClass("selected");
                        $(events_content)
                            .append(`<li data-date=` + date + `>
                                        <h2>Consultation ` + (nb + 1) + `</h2>
                                        <em>` + date_em + `</em>
                                        <div class="row">
                                            <div class="form-group"><label class="control-label required" for="patient_creation_form_rendezVous_` + resp + `_date">Date prévue</label><input type="text" id="patient_creation_form_rendezVous_` + resp + `_date" name="patient_creation_form[rendezVous][` + resp + `][date]" required="required" class="datepicker form-control" value="` + date + `"></div>
                                        </div>
                                        <div class="row">
                                            <div class="form-group"><label class="control-label required" for="patient_creation_form_rendezVous_` + resp + `_thematique">Thématique</label><select id="patient_creation_form_rendezVous_` + resp + `_thematique" name="patient_creation_form[rendezVous][` + resp + `][thematique]" required="required" class="form-control"><option value=""></option><option value="Consultation psychologue">Consultation psychologue</option><option value="Consultation diététicienne">Consultation diététicienne</option><option value="Consultation pharmacienne">Consultation pharmacienne</option></select></div>
                                        </div>
                                        <div class="row">
                                            <div class="form-group"><label class="control-label" for="patient_creation_form_rendezVous_` + resp + `_heure">Heure</label><select id="patient_creation_form_rendezVous_` + resp + `_heure" name="patient_creation_form[rendezVous][` + resp + `][heure]" class="form-control"><option value=""></option><option value="09:15">09:15</option><option value="10:15">10:15</option><option value="11:15">11:15</option><option value="11:30">11:30</option><option value="12:30">12:30</option><option value="14:00">14:00</option><option value="15:00">15:00</option><option value="16:00">16:00</option></select></div>
                                        </div>
                                        <div class="row">
                                            <div class="form-group"><label class="control-label" for="patient_creation_form_rendezVous_` + resp + `_type">Type</label><select id="patient_creation_form_rendezVous_` + resp + `_type" name="patient_creation_form[rendezVous][` + resp + `][type]" class="form-control"><option value=""></option><option value="Ambu">Ambu</option><option value="Tel">Tel</option><option value="Hospi">Hospi</option></select></div>
                                        </div>
                                        <div class="row">
                                            <div class="form-group"><label class="control-label" for="patient_creation_form_rendezVous_` + resp + `_accompagnant">Accompagnant</label><select id="patient_creation_form_rendezVous_` + resp + `_accompagnant" name="patient_creation_form[rendezVous][` + resp + `][accompagnant]" class="form-control"><option value=""></option><option value="oui">Oui</option><option value="non">Non</option></select></div>
                                        </div>
                                        <div class="row">
                                            <div class="form-group"><label class="control-label" for="patient_creation_form_rendezVous_` + resp + `_etat">A-t-il eu lieu ?</label><select id="patient_creation_form_rendezVous_` + resp + `_etat" name="patient_creation_form[rendezVous][` + resp + `][etat]" class="form-control" style="background: white;"><option value="" class="white"></option><option value="Oui" class="hotpink">Oui</option><option value="Non" class="yellow">Non</option></select></div>
                                        </div>
                                        <div class="row">
                                            <div class="form-group"><label class="control-label" for="patient_creation_form_rendezVous_` + resp + `_motifRefus">Motif de refus</label><input type="text" id="patient_creation_form_rendezVous_` + resp + `_motifRefus" name="patient_creation_form[rendezVous][` + resp + `][motifRefus]" class="form-control" value=` + motifRefus + `></div>
                                        </div>
                                        <div class="row">
                                            <button type="button" class="btn btn-primary pull-right">Modifier</button>
                                            <button type="button" class="btn btn-danger pull-left">Supprimer</button>
                                        </div>
                                    </li>`)
                            .appendTo(events_content);
                        $('#patient_creation_form_rendezVous_' + resp + '_thematique').val(thematique);
                        $('#patient_creation_form_rendezVous_' + resp + '_heure').val(time);
                        $('#patient_creation_form_rendezVous_' + resp + '_type').val(type);
                        $('#patient_creation_form_rendezVous_' + resp + '_accompagnant').val(accompagnant);
                        $('#patient_creation_form_rendezVous_' + resp + '_etat').val(etat);
                        $('#events-content-rendezVous li:last-child').addClass('selected');

                        updateForm();
                        document.getElementById("rendezVous_add").disabled = true;
                    }
                }
            });
        });

        function formatDate(input) {
            var datePart = input.match(/\d+/g),
                year = datePart[2] //.substring(2),  get only two digits
                month = datePart[1],
                day = datePart[0];
            return year + '-' + month + '-' + day;
        }

        function resetErrors() {
            $('input, select').removeClass('is-invalid');
            $(".invalid-feedback").remove();
        }

        /* Annexes
	    ================= */

        {# Add #}

        var $addTagLink = $('.card-add');
        var $collectionHolder = $('ul.annexes');
        $collectionHolder.data('index', $collectionHolder.find(':input').length);

        $addTagLink.on('click', function (e) {
            e.preventDefault();
            addTagForm($collectionHolder);
            $('.datepicker').datepicker({language: 'fr', format: 'dd/mm/yyyy', todayBtn: true, todayHighlight: true, autoclose: true});
        });

        function addTagForm($collectionHolder) {
            var prototype = $collectionHolder.data('prototype');
            var index = $collectionHolder.data('index');
            var newForm = prototype.replace(/__name__/g, index);
            $collectionHolder.data('index', index + 1);
            var $newFormLi = $('<li class="card"></li>').append(newForm);
            $newFormLi.append('<a href="#" class="pull-left btn btn-danger remove-tag">Supprimer</a>');
            $collectionHolder.prepend($newFormLi);
        }
        
        {# Delete #}

        $(".activity-wrapper").on("click", ".remove-tag", function (e) {
            e.preventDefault();
            $(this).parent().remove();
            if ($(this).hasClass('annexe-old')) {
                var id = $(this).parents().find('.datepicker').attr("name").match(/\d+/)[0];
                var url = "{{ path( 'annexe_remove', { 'id': 'annexe_id' }) }}";
                url = url.replace("annexe_id", id);
                $.ajax({url: url, type: "DELETE", success: function (resp) {}});
            }
            return false;
        });

        function sortSelect() {
            $('.container-fluid').find('select').each(function() {
                let sel = $(this);
                let selected = sel.val();
                let opts_list = sel.find('option');
                opts_list.sort(function(a, b) { return $(a).text() > $(b).text() ? 1 : -1; });
                sel.html('').append(opts_list);
                sel.val(selected);
            });
        }

    </script>

    <script src="{{ asset('js/timeline.js') }}"></script>

    {# function reload_js(src) {
       	$('script[src="' + src + '"]').remove();
       	$('<script>').attr('src', src).appendTo('body');
   	} #}

    {# $.getScript("{{ asset('js/timeline.js') }}"); #}
    {# $(this).closest('tr').remove(); #}
    {# $('section#timeline-entretiens').load(location.href + ' #timeline-entretiens'); #}

{% endblock %}